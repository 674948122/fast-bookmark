# Chrome History API Investigation & Fix Plan

The user reports that the "Recently Visited" data is still incorrect. I suspect the filtering logic is too strict or the `maxResults` limit is preventing relevant bookmarks from being found if the user has browsed many non-bookmark pages recently.

## 1. Analysis of `chrome.history.search`
- **Current Query**: `{ text: '', maxResults: 1000, startTime: ... }`
- **Issue**: `chrome.history.search` returns results sorted by relevance/recency. If the user has visited >1000 pages recently (very common if they browse Reddit, Twitter, or Infinite Scroll sites), and none of them are bookmarks, the API will return 1000 non-bookmark items. The subsequent filter `historyItems.filter(item => bookmarkUrls.has(item.url))` will return **0** matches.
- **Documentation Insight**: The `chrome.history.search` API does not allow filtering by "is bookmark" natively. We must fetch *enough* history to find the bookmarks.

## 2. Solution Strategy
- **Increase `maxResults`**: 1000 might be too low for active users. Increasing to 5000 or 10000 ensures we dig deeper into history to find bookmark visits.
- **Normalize URLs**:
  - Bookmarks might store `https://example.com/` (trailing slash).
  - History might return `https://example.com` (no slash).
  - Or query params might differ.
  - **Action**: Normalize URLs before comparison. At minimum, strip trailing slashes and maybe `www.` if needed, but strict exact match is safer for bookmarks. I will verify if `chrome.history` returns exact URLs. It usually does.
  - **Refined Matching**: Ensure `bookmarkUrls` Set contains exact strings.
- **Debugging**: I'll add a log to see how many history items are fetched and how many match.

## 3. Plan Details
1.  **Modify `background.js`**:
    - Increase `maxResults` to `10000` (Chrome cap is high, but performance matters. 5000-10000 is reasonable).
    - Add URL normalization: Strip trailing slashes from both bookmark URLs and history URLs before comparison to improve hit rate.
    - Ensure `startTime` is reasonable (30 days is fine, but maybe 90 days?). Let's stick to 30 days but fetch more items.
2.  **Verify**:
    - The `Set` lookup is efficient (`O(1)`), so processing 10,000 items is fast (milliseconds).

## 4. Implementation
- Update `background.js`:
  ```javascript
  const historyItems = await chrome.history.search({ 
      text: '', 
      maxResults: 10000, // Increased from 1000
      startTime: Date.now() - 90 * 24 * 60 * 60 * 1000 // Increased to 90 days
  });
  
  // Normalization helper
  const normalizeUrl = (url) => url.replace(/\/$/, '');
  
  const bookmarkUrls = new Set(data.flattened.map(b => normalizeUrl(b.url)));
  
  const recentBookmarks = historyItems
      .filter(item => bookmarkUrls.has(normalizeUrl(item.url)))
      .slice(0, 20);
  ```
