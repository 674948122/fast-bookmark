# Switch Recent Bookmarks to Browser History Plan

I will modify the "Recently Visited" feature to fetch data directly from the browser's history (`chrome.history` API) instead of relying on the extension's internal storage. This ensures the data reflects actual browser usage, including visits outside the extension.

## 1. Permission Update (`manifest.json`)
- Add `"history"` to the `permissions` list to allow access to `chrome.history`.

## 2. Update Data Fetching Logic (`background.js`)
- **Modify `getBookmarks` handler**:
  - Instead of reading `recentBookmarks` from `chrome.storage.local`, call `chrome.history.search`.
  - **Query**: `{ text: "", maxResults: 100 }` (fetch enough to filter).
  - **Filter**: The user wants "Recent *Bookmarks*". So, after fetching history, I must filter the results to include *only* URLs that are actually in the user's bookmarks.
  - **Return**: Pass this list of history items (containing `url` and `lastVisitTime`) back to the content script.
- **Remove** the old `recentBookmarks` storage logic (openBookmark listener updates). We no longer need to manually track clicks if we use the history API.

## 3. Update Data Processing (`content.js`)
- **Modify `fetchBookmarks`**:
  - The response from `background.js` (via `getBookmarks` or a new action) needs to include the history-derived recent list.
  - Currently, `getBookmarks` returns the bookmark tree. I should probably add a separate step or include it in the response.
  - **Better approach**: In `background.js`, when `getBookmarks` is called, perform the history fetch + bookmark filtering *there*, and return the `recentUrls` (as objects with timestamps) in the same response payload.
- **Modify `processBookmarks`**:
  - It already handles the object structure `{ url, lastVisitTime }`.
  - Ensure it uses the new list from the response.

## 4. Implementation Details
- **Filtering Logic**:
  - Fetch all bookmarks (flattened list) first.
  - Fetch history (`chrome.history.search({text: '', maxResults: 1000})`).
  - Create a Set of bookmark URLs for fast lookup.
  - Iterate through history items: if `bookmarkSet.has(historyItem.url)`, add to `recentItems`.
  - Limit to 20 items.
  - Return this list.

## 5. Verification
- Verify `manifest.json` has `history`.
- Reload extension.
- Open "Recently Visited" folder.
- Verify it shows pages I actually visited recently (that are bookmarked).
- Verify the timestamps match browser history.
